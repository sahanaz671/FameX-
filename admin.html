<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FameX | Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CLEAN PROFESSIONAL DARK THEME --- */
        :root {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --border: #333;
            --accent: #7c4dff; /* Purple to match main site */
            --text-main: #ffffff;
            --text-muted: #b0b0b0;
            --success: #00c853;
            --danger: #ff5252;
            --warning: #ffd740;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
        }

        /* NAVBAR */
        .navbar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .brand { font-size: 1.5rem; font-weight: bold; letter-spacing: 1px; }
        .brand span { color: var(--accent); }
        .logout-btn {
            background: #333; color: white; border: none;
            padding: 8px 15px; border-radius: 5px; cursor: pointer;
            font-size: 0.9rem; transition: 0.2s;
        }
        .logout-btn:hover { background: var(--danger); }

        /* LAYOUT */
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

        /* KPI CARDS */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .stat-info h3 { margin: 0; font-size: 2rem; font-weight: bold; }
        .stat-info p { margin: 5px 0 0; color: var(--text-muted); font-size: 0.9rem; }
        .stat-icon { font-size: 2.5rem; opacity: 0.2; }

        /* TABS */
        .tabs { margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .tab-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 15px 25px; font-size: 1rem; cursor: pointer;
            border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: bold; }
        .tab-btn:hover { color: white; }

        /* TABLES */
        .section { display: none; }
        .section.active { display: block; }

        .table-container {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            text-align: left; padding: 18px;
            background: #252525; color: var(--text-muted);
            font-size: 0.85rem; text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }
        td { padding: 18px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background: #2a2a2a; }

        /* ACTION BUTTONS */
        .btn-action {
            padding: 6px 12px; border-radius: 4px; border: none;
            font-size: 0.8rem; cursor: pointer; font-weight: bold; margin-right: 5px;
        }
        .btn-green { background: rgba(0, 200, 83, 0.15); color: var(--success); }
        .btn-green:hover { background: var(--success); color: white; }
        
        .btn-red { background: rgba(255, 82, 82, 0.15); color: var(--danger); }
        .btn-red:hover { background: var(--danger); color: white; }
        
        .btn-blue { background: rgba(124, 77, 255, 0.15); color: var(--accent); }
        .btn-blue:hover { background: var(--accent); color: white; }

        .input-edit {
            background: #111; border: 1px solid var(--border);
            color: white; padding: 5px; width: 70px; text-align: center; border-radius: 4px;
        }

        /* STATUS BADGES */
        .badge { padding: 4px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: bold; }
        .badge-pending { background: rgba(255, 215, 64, 0.1); color: var(--warning); border: 1px solid var(--warning); }
        .badge-success { background: rgba(0, 200, 83, 0.1); color: var(--success); border: 1px solid var(--success); }
        .badge-danger { background: rgba(255, 82, 82, 0.1); color: var(--danger); border: 1px solid var(--danger); }

        /* LOGIN SCREEN */
        .login-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box {
            background: var(--bg-card); padding: 40px; border-radius: 10px;
            border: 1px solid var(--border); text-align: center; width: 350px;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="login-wrapper">
        <div class="login-box">
            <h2 class="brand">Fame<span>X</span> Admin</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">Restricted Access</p>
            <button class="logout-btn" id="adminLoginBtn" style="width:100%; background:var(--accent);">Login with Google</button>
        </div>
    </div>

    <div id="dashboard" style="display:none;">
        
        <nav class="navbar">
            <div class="brand">Fame<span>X</span> Admin</div>
            <button class="logout-btn" id="adminLogoutBtn">Logout</button>
        </nav>

        <div class="container">
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-info"><h3 id="totalUsers">0</h3><p>Total Users</p></div>
                    <i class="fas fa-users stat-icon" style="color:var(--accent);"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3 id="pendingOrders">0</h3><p>Pending Orders</p></div>
                    <i class="fas fa-shopping-cart stat-icon" style="color:var(--warning);"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3 id="pendingPayments">0</h3><p>Payment Requests</p></div>
                    <i class="fas fa-wallet stat-icon" style="color:var(--success);"></i>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('users')">Users Management</button>
                <button class="tab-btn" onclick="showTab('orders')">Orders</button>
                <button class="tab-btn" onclick="showTab('payments')">Payment Verification</button>
            </div>

            <div id="users" class="section active">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>All Users</h3>
                    <button class="btn-action btn-blue" onclick="loadUsers()"><i class="fas fa-sync"></i> Refresh</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>User Details</th>
                                <th>Balance (₹)</th>
                                <th>Stats</th>
                                <th>Referral Code</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="orders" class="section">
                <h3>Latest Orders</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>User</th>
                                <th>Service / Link</th>
                                <th>Cost</th>
                                <th>Status</th>
                                <th>Update</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="payments" class="section">
                <h3>Payment Verification</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th> <th>User</th>
                                <th>Amount / UTR</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="payment-table-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, getDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAN_hd8rr46X25lOZ0cKwe6pAVl2sh61AI",
            authDomain: "famex-4cb1e.firebaseapp.com",
            projectId: "famex-4cb1e",
            storageBucket: "famex-4cb1e.firebasestorage.app",
            messagingSenderId: "395925089964",
            appId: "1:395925089964:web:551ef2089aa25d09743909",
            measurementId: "G-S1T0L618XL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // ⚠️ ADMIN EMAIL
        const ADMIN_EMAIL = "yoursa.in.here@gmail.com"; 

        // LOGIN CHECK
        onAuthStateChanged(auth, (user) => {
            if (user && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                initData();
            } else if (user) {
                alert("Access Denied. Admins Only.");
                signOut(auth);
            }
        });

        document.getElementById('adminLoginBtn').addEventListener('click', () => signInWithPopup(auth, provider));
        document.getElementById('adminLogoutBtn').addEventListener('click', () => signOut(auth).then(()=>window.location.reload()));

        window.showTab = (tabId) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function initData() {
            loadUsers();
            loadOrders();
            loadPayments();
        }

        // --- 1. USERS ---
        window.loadUsers = async () => {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center;">Loading...</td></tr>';
            
            const q = query(collection(db, "users"), orderBy("balance", "desc"));
            const snapshot = await getDocs(q);
            
            tbody.innerHTML = '';
            document.getElementById('totalUsers').innerText = snapshot.size;

            snapshot.forEach(docSnap => {
                const user = docSnap.data();
                const uid = docSnap.id;
                const isBanned = user.forceLogout === true;

                const row = `
                    <tr style="${isBanned ? 'background:rgba(255,0,0,0.05);' : ''}">
                        <td>
                            <strong>${user.name}</strong> <br>
                            <span style="color:#666; font-size:0.8rem;">${user.email}</span>
                            ${isBanned ? '<br><span style="color:var(--danger); font-weight:bold; font-size:0.7rem;">[BANNED]</span>' : ''}
                        </td>
                        <td>
                            <input type="number" class="input-edit" id="bal-${uid}" value="${user.balance || 0}">
                            <button class="btn-action btn-blue" onclick="saveBalance('${uid}')">Save</button>
                        </td>
                        <td style="font-size:0.85rem;">
                            Orders: <b>${user.totalOrders || 0}</b> <br>
                            Spent: ₹${user.totalSpent || 0}
                        </td>
                        <td style="font-size:0.9rem; letter-spacing:1px; color:var(--text-muted);">
                            ${user.referralCode || '-'}
                        </td>
                        <td>
                            ${isBanned 
                                ? `<button class="btn-action btn-green" onclick="toggleBan('${uid}', false)">Unban</button>`
                                : `<button class="btn-action btn-red" onclick="toggleBan('${uid}', true)">Ban</button>`
                            }
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        window.saveBalance = async (uid) => {
            const val = document.getElementById(`bal-${uid}`).value;
            await updateDoc(doc(db, "users", uid), { balance: parseFloat(val) });
            alert("Balance updated.");
        }

        window.toggleBan = async (uid, status) => {
            if(!confirm(status ? "Ban this user?" : "Unban this user?")) return;
            await updateDoc(doc(db, "users", uid), { forceLogout: status });
            loadUsers();
        }

        // --- 2. ORDERS ---
        window.loadOrders = () => {
            const tbody = document.getElementById('orders-table-body');
            const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snap) => {
                tbody.innerHTML = '';
                let pending = 0;
                
                snap.forEach(docSnap => {
                    const order = docSnap.data();
                    const oid = docSnap.id;
                    if(order.status === 'Pending') pending++;

                    // Format Time
                    const date = order.timestamp ? order.timestamp.toDate().toLocaleString() : 'N/A';
                    
                    let badge = 'badge-pending';
                    if(order.status === 'Processing') badge = 'badge-success'; // re-using green for processing
                    if(order.status === 'Completed') badge = 'badge-success';
                    if(order.status === 'Cancelled') badge = 'badge-danger';

                    const row = `
                        <tr>
                            <td style="font-size:0.85rem; color:#888;">${date}</td>
                            <td>
                                <b>${order.userName}</b><br>
                                <span style="font-size:0.8rem; color:#666;">${order.userEmail}</span>
                            </td>
                            <td>
                                <strong style="color:var(--accent);">${order.service}</strong><br>
                                <a href="${order.link}" target="_blank" style="color:#888; font-size:0.8rem; text-decoration:none;">${order.link.substring(0,25)}...</a>
                                <span style="font-size:0.8rem;">(Qty: ${order.quantity})</span>
                            </td>
                            <td style="font-weight:bold;">₹${order.cost}</td>
                            <td><span class="badge ${badge}">${order.status}</span></td>
                            <td>
                                <select onchange="updateOrderStatus('${oid}', this.value)" style="padding:5px; background:#222; color:white; border:1px solid #444; border-radius:4px;">
                                    <option>Action...</option>
                                    <option value="Processing">Processing</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                document.getElementById('pendingOrders').innerText = pending;
            });
        }

        window.updateOrderStatus = async (oid, status) => {
            if(status === 'Action...') return;
            await updateDoc(doc(db, "orders", oid), { status: status });
        }

        // --- 3. PAYMENTS ---
        window.loadPayments = () => {
            const tbody = document.getElementById('payment-table-body');
            const q = query(collection(db, "payment_verifications"), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snap) => {
                tbody.innerHTML = '';
                let pending = 0;

                snap.forEach(docSnap => {
                    const pay = docSnap.data();
                    const pid = docSnap.id;
                    if(pay.status === 'Checking') pending++;

                    // 1. FORMAT DATE AND TIME
                    const date = pay.timestamp ? pay.timestamp.toDate().toLocaleString() : 'N/A';

                    let badge = 'badge-pending';
                    if(pay.status === 'Success') badge = 'badge-success';
                    if(pay.status === 'Rejected') badge = 'badge-danger';

                    const row = `
                        <tr>
                            <td style="font-size:0.85rem; color:#888;">${date}</td>
                            <td>
                                <b>${pay.userName}</b><br>
                                <span style="font-size:0.8rem; color:#666;">${pay.userEmail}</span>
                            </td>
                            <td>
                                <div style="font-size:1.1rem; font-weight:bold; color:var(--success);">₹${pay.amount}</div>
                                <div style="font-size:0.8rem;">UTR: ${pay.utr}</div>
                                <div style="font-size:0.8rem; color:#666;">Sender: ${pay.senderName}</div>
                            </td>
                            <td><span class="badge ${badge}">${pay.status}</span></td>
                            <td>
                                ${pay.status === 'Checking' ? `
                                    <button class="btn-action btn-green" onclick="approvePay('${pid}', '${pay.userId}', ${pay.amount})">Approve</button>
                                    <button class="btn-action btn-red" onclick="rejectPay('${pid}')">Reject</button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                document.getElementById('pendingPayments').innerText = pending;
            });
        }

        window.approvePay = async (pid, uid, amount) => {
            if(!confirm(`Add ₹${amount} to user wallet?`)) return;
            try {
                // 1. Update Payment Status
                await updateDoc(doc(db, "payment_verifications", pid), { status: "Success" });
                
                // 2. Add Money & Update Stats
                const userRef = doc(db, "users", uid);
                await updateDoc(userRef, { 
                    balance: increment(parseInt(amount)),
                    totalDeposited: increment(parseInt(amount))
                });
                alert("Success! Money added.");
            } catch(e) { alert(e.message); }
        }

        window.rejectPay = async (pid) => {
            if(!confirm("Reject this request?")) return;
            await updateDoc(doc(db, "payment_verifications", pid), { status: "Rejected" });
        }

    </script>
</body>
</html>
