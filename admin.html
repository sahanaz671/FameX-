<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FameX | Admin Nexus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- DREAMY GLOWING UI THEME --- */
        :root {
            --bg-body: #050505;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #7c4dff;
            --accent-glow: 0 0 20px rgba(124, 77, 255, 0.5);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --success: #00e676;
            --success-glow: 0 0 15px rgba(0, 230, 118, 0.4);
            --danger: #ff5252;
            --danger-glow: 0 0 15px rgba(255, 82, 82, 0.4);
            --warning: #ffd740;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif;
            background-color: var(--bg-body);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(124, 77, 255, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 230, 118, 0.05) 0%, transparent 40%);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* NAVBAR */
        .navbar {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .brand { font-size: 1.8rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }
        .brand span { color: var(--accent); text-shadow: var(--accent-glow); }
        
        .logout-btn {
            background: rgba(255, 82, 82, 0.1); 
            color: var(--danger); 
            border: 1px solid var(--danger);
            padding: 8px 20px; border-radius: 50px; cursor: pointer;
            font-weight: bold; transition: 0.3s;
        }
        .logout-btn:hover { background: var(--danger); color: white; box-shadow: var(--danger-glow); }

        /* LAYOUT */
        .container { max-width: 1400px; margin: 40px auto; padding: 0 20px; }

        /* KPI CARDS */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px; margin-bottom: 40px;
        }
        .stat-card {
            background: var(--glass);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: var(--accent-glow); }
        .stat-info h3 { margin: 0; font-size: 2.5rem; font-weight: 800; }
        .stat-info p { margin: 5px 0 0; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .stat-icon { font-size: 3rem; opacity: 0.8; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }

        /* TABS */
        .tabs { margin-bottom: 30px; border-bottom: 1px solid var(--glass-border); display: flex; gap: 20px; }
        .tab-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 15px 10px; font-size: 1.1rem; cursor: pointer;
            border-bottom: 3px solid transparent; transition: 0.3s; font-weight: 500;
        }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); text-shadow: var(--accent-glow); }
        .tab-btn:hover { color: white; }

        /* TABLES */
        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .table-container {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            overflow-x: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th {
            text-align: left; padding: 20px;
            background: rgba(255,255,255,0.03); color: var(--accent);
            font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 1px solid var(--glass-border);
        }
        td { padding: 20px; border-bottom: 1px solid var(--glass-border); vertical-align: middle; }
        tr:hover td { background: rgba(255,255,255,0.02); }
        tr:last-child td { border-bottom: none; }

        /* ACTION BUTTONS */
        .action-group { display: flex; gap: 10px; }
        .btn-action {
            padding: 8px 16px; border-radius: 8px; border: none;
            font-size: 0.85rem; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 6px; transition: 0.3s;
        }
        .btn-green { background: rgba(0, 230, 118, 0.1); color: var(--success); border: 1px solid var(--success); }
        .btn-green:hover { background: var(--success); color: black; box-shadow: var(--success-glow); }
        
        .btn-red { background: rgba(255, 82, 82, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-red:hover { background: var(--danger); color: white; box-shadow: var(--danger-glow); }
        
        .btn-blue { background: rgba(124, 77, 255, 0.1); color: var(--accent); border: 1px solid var(--accent); }
        .btn-blue:hover { background: var(--accent); color: white; box-shadow: var(--accent-glow); }

        .input-edit {
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            color: white; padding: 8px; width: 80px; text-align: center; border-radius: 8px;
            font-weight: bold;
        }
        .input-edit:focus { border-color: var(--accent); outline: none; }

        /* BADGES */
        .badge { padding: 5px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-pending { background: rgba(255, 215, 64, 0.1); color: var(--warning); border: 1px solid var(--warning); }
        .badge-success { background: rgba(0, 230, 118, 0.1); color: var(--success); border: 1px solid var(--success); box-shadow: var(--success-glow); }
        .badge-danger { background: rgba(255, 82, 82, 0.1); color: var(--danger); border: 1px solid var(--danger); }

        /* LOGIN SCREEN */
        .login-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); display: flex; justify-content: center; align-items: center; z-index: 999;
            backdrop-filter: blur(10px);
        }
        .login-box {
            background: #111; padding: 50px; border-radius: 25px;
            border: 1px solid var(--glass-border); text-align: center; width: 400px;
            box-shadow: 0 0 50px rgba(124, 77, 255, 0.15);
        }
    </style>
</head>
<body>

    <div id="login-screen" class="login-wrapper">
        <div class="login-box">
            <h2 class="brand" style="font-size:2.5rem; margin-bottom:10px;">Fame<span>X</span></h2>
            <p style="color:var(--text-muted); margin-bottom:30px;">Admin Access Terminal</p>
            <button class="btn-action btn-blue" id="adminLoginBtn" style="width:100%; justify-content:center; padding:12px;">
                <i class="fab fa-google"></i> Secure Login
            </button>
        </div>
    </div>

    <div id="dashboard" style="display:none;">
        
        <nav class="navbar">
            <div class="brand">Fame<span>X</span> <span style="font-size:0.8rem; color:var(--text-muted); margin-left:10px;">ADMIN</span></div>
            <button class="logout-btn" id="adminLogoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </nav>

        <div class="container">
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-info"><h3 id="totalUsers">0</h3><p>Total Users</p></div>
                    <i class="fas fa-users stat-icon" style="color:var(--accent);"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3 id="pendingOrders">0</h3><p>Pending Orders</p></div>
                    <i class="fas fa-shopping-cart stat-icon" style="color:var(--warning);"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3 id="pendingPayments">0</h3><p>Payment Requests</p></div>
                    <i class="fas fa-wallet stat-icon" style="color:var(--success);"></i>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('users')">Users Management</button>
                <button class="tab-btn" onclick="showTab('orders')">Orders</button>
                <button class="tab-btn" onclick="showTab('payments')">Payment Verification</button>
                <button class="tab-btn" onclick="showTab('withdrawals')">Withdrawals</button>
            </div>

            <div id="users" class="section active">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                    <h3 style="margin:0;">User Database</h3>
                    <button class="btn-action btn-blue" onclick="loadUsers()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>User Profile</th>
                                <th>Wallet Balance</th>
                                <th>Statistics</th>
                                <th>Referral Info</th>
                                <th>Controls</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="orders" class="section">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                    <h3 style="margin:0;">Order Stream</h3>
                    <button class="btn-action btn-blue" onclick="loadOrders()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Customer</th>
                                <th>Service Details</th>
                                <th>Cost</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="payments" class="section">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                    <h3 style="margin:0;">Incoming Payments</h3>
                    <button class="btn-action btn-blue" onclick="loadPayments()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Received At</th> 
                                <th>User</th>
                                <th>Amount / Bonus</th>
                                <th>Status</th>
                                <th>Verdict</th>
                            </tr>
                        </thead>
                        <tbody id="payment-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="withdrawals" class="section">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                    <h3 style="margin:0;">Referral Withdrawals</h3>
                    <button class="btn-action btn-blue" onclick="loadWithdrawals()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th> 
                                <th>User</th>
                                <th>Amount</th>
                                <th>UPI / PhonePe</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawals-table-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, getDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAN_hd8rr46X25lOZ0cKwe6pAVl2sh61AI",
            authDomain: "famex-4cb1e.firebaseapp.com",
            projectId: "famex-4cb1e",
            storageBucket: "famex-4cb1e.firebasestorage.app",
            messagingSenderId: "395925089964",
            appId: "1:395925089964:web:551ef2089aa25d09743909",
            measurementId: "G-S1T0L618XL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const ADMIN_EMAIL = "yoursa.in.here@gmail.com"; 

        onAuthStateChanged(auth, (user) => {
            if (user && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                initData();
            } else if (user) {
                alert("Access Denied. Admins Only.");
                signOut(auth);
            }
        });

        document.getElementById('adminLoginBtn').addEventListener('click', () => signInWithPopup(auth, provider));
        document.getElementById('adminLogoutBtn').addEventListener('click', () => signOut(auth).then(()=>window.location.reload()));

        window.showTab = (tabId) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function initData() {
            loadUsers();
            loadOrders();
            loadPayments();
            loadWithdrawals();
        }

        // --- 1. USERS ---
        window.loadUsers = async () => {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '<tr><td colspan="5" style="padding:30px; text-align:center;">Loading...</td></tr>';
            
            const q = query(collection(db, "users"), orderBy("balance", "desc"));
            const snapshot = await getDocs(q);
            
            tbody.innerHTML = '';
            document.getElementById('totalUsers').innerText = snapshot.size;

            snapshot.forEach(docSnap => {
                const user = docSnap.data();
                const uid = docSnap.id;
                const isBanned = user.forceLogout === true;

                const row = `
                    <tr style="${isBanned ? 'opacity:0.5;' : ''}">
                        <td>
                            <div style="font-weight:bold; font-size:1rem;">${user.name}</div>
                            <div style="color:var(--text-muted); font-size:0.8rem;">${user.email}</div>
                            ${isBanned ? '<span style="color:var(--danger); font-size:0.7rem; font-weight:bold;">[BANNED]</span>' : ''}
                        </td>
                        <td>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <input type="number" class="input-edit" id="bal-${uid}" value="${user.balance || 0}">
                                <button class="btn-action btn-blue" onclick="saveBalance('${uid}')"><i class="fas fa-save"></i></button>
                            </div>
                        </td>
                        <td style="font-size:0.85rem; color:var(--text-muted);">
                            Orders: <b style="color:white;">${user.totalOrders || 0}</b> <br>
                            Spent: <b style="color:white;">₹${user.totalSpent || 0}</b>
                        </td>
                        <td style="font-size:0.85rem;">
                            Code: <span style="color:var(--accent);">${user.referralCode || '-'}</span> <br>
                            Earnings: <span style="color:var(--gold);">₹${user.referralEarnings || 0}</span>
                        </td>
                        <td>
                            ${isBanned 
                                ? `<button class="btn-action btn-green" onclick="toggleBan('${uid}', false)">Unban</button>`
                                : `<button class="btn-action btn-red" onclick="toggleBan('${uid}', true)">Ban</button>`
                            }
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        window.saveBalance = async (uid) => {
            const val = document.getElementById(`bal-${uid}`).value;
            await updateDoc(doc(db, "users", uid), { balance: parseFloat(val) });
            alert("Balance updated.");
        }

        window.toggleBan = async (uid, status) => {
            if(!confirm(status ? "Ban this user?" : "Unban this user?")) return;
            await updateDoc(doc(db, "users", uid), { forceLogout: status });
            loadUsers();
        }

        // --- 2. ORDERS ---
        window.loadOrders = () => {
            const tbody = document.getElementById('orders-table-body');
            const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snap) => {
                tbody.innerHTML = '';
                let pending = 0;
                
                snap.forEach(docSnap => {
                    const order = docSnap.data();
                    const oid = docSnap.id;
                    if(order.status === 'Pending') pending++;

                    const date = order.timestamp ? order.timestamp.toDate().toLocaleString() : 'N/A';
                    
                    let badge = 'badge-pending';
                    if(order.status === 'Processing') badge = 'badge-success'; 
                    if(order.status === 'Completed') badge = 'badge-success';
                    if(order.status === 'Cancelled') badge = 'badge-danger';

                    const row = `
                        <tr>
                            <td style="font-size:0.85rem; color:var(--text-muted);">${date}</td>
                            <td>
                                <b>${order.userName}</b><br>
                                <span style="font-size:0.8rem; color:var(--text-muted);">${order.userEmail}</span>
                            </td>
                            <td>
                                <strong style="color:var(--accent);">${order.service}</strong><br>
                                <a href="${order.link}" target="_blank" style="color:var(--text-muted); font-size:0.8rem;">Link <i class="fas fa-external-link-alt"></i></a>
                                <span style="font-size:0.8rem; margin-left:10px;">(Qty: ${order.quantity})</span>
                            </td>
                            <td style="font-weight:bold; font-size:1.1rem;">₹${order.cost}</td>
                            <td><span class="badge ${badge}">${order.status}</span></td>
                            <td>
                                <select onchange="updateOrderStatus('${oid}', this.value)" style="padding:8px; background:#111; color:white; border:1px solid var(--border); border-radius:8px;">
                                    <option>Change...</option>
                                    <option value="Processing">Processing</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                document.getElementById('pendingOrders').innerText = pending;
            });
        }

        window.updateOrderStatus = async (oid, status) => {
            if(status === 'Change...') return;
            await updateDoc(doc(db, "orders", oid), { status: status });
        }

        // --- 3. PAYMENTS ---
        window.loadPayments = () => {
            const tbody = document.getElementById('payment-table-body');
            const q = query(collection(db, "payment_verifications"), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snap) => {
                tbody.innerHTML = '';
                let pending = 0;

                snap.forEach(docSnap => {
                    const pay = docSnap.data();
                    const pid = docSnap.id;
                    if(pay.status === 'Checking') pending++;

                    const date = pay.timestamp ? pay.timestamp.toDate().toLocaleString() : 'N/A';
                    let badge = 'badge-pending';
                    if(pay.status === 'Success') badge = 'badge-success';
                    if(pay.status === 'Rejected') badge = 'badge-danger';

                    // Show Bonus Info
                    const bonusInfo = pay.bonusType ? `<br><span style="color:var(--gold); font-size:0.75rem;"><i class="fas fa-star"></i> ${pay.bonusType}</span>` : '';

                    const row = `
                        <tr>
                            <td style="font-size:0.85rem; color:var(--text-muted);">${date}</td>
                            <td>
                                <b>${pay.userName}</b><br>
                                <span style="font-size:0.8rem; color:var(--text-muted);">${pay.userEmail}</span>
                            </td>
                            <td>
                                <div style="font-size:1.2rem; font-weight:bold; color:var(--success);">₹${pay.amount}</div>
                                <div style="font-size:0.8rem; color:var(--text-muted);">UTR: ${pay.utr}</div>
                                ${bonusInfo}
                            </td>
                            <td><span class="badge ${badge}">${pay.status}</span></td>
                            <td>
                                ${pay.status === 'Checking' ? `
                                    <div class="action-group">
                                        <button class="btn-action btn-green" onclick="approvePay('${pid}', '${pay.userId}', ${pay.amount})"><i class="fas fa-check"></i> Approve</button>
                                        <button class="btn-action btn-red" onclick="rejectPay('${pid}')"><i class="fas fa-times"></i> Reject</button>
                                    </div>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                document.getElementById('pendingPayments').innerText = pending;
            });
        }

        window.approvePay = async (pid, uid, amount) => {
            if(!confirm(`Add ₹${amount} to user wallet?`)) return;
            try {
                // 1. Update Payment
                await updateDoc(doc(db, "payment_verifications", pid), { status: "Success" });
                
                // 2. Add Money
                const userRef = doc(db, "users", uid);
                await updateDoc(userRef, { 
                    balance: increment(parseInt(amount)),
                    totalDeposited: increment(parseInt(amount))
                });
                
                // 3. Referral Bonus Logic (Optional, can be added later if needed)
                
                alert("Success! Money added.");
            } catch(e) { alert(e.message); }
        }

        window.rejectPay = async (pid) => {
            if(!confirm("Reject this request?")) return;
            await updateDoc(doc(db, "payment_verifications", pid), { status: "Rejected" });
        }

        // --- 4. WITHDRAWALS ---
        window.loadWithdrawals = () => {
            const tbody = document.getElementById('withdrawals-table-body');
            const q = query(collection(db, "withdrawals"), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snap) => {
                tbody.innerHTML = '';
                snap.forEach(docSnap => {
                    const w = docSnap.data();
                    const wid = docSnap.id;
                    const date = w.timestamp ? w.timestamp.toDate().toLocaleString() : 'N/A';
                    
                    let badge = 'badge-pending';
                    if(w.status === 'Paid') badge = 'badge-success';
                    if(w.status === 'Rejected') badge = 'badge-danger';

                    const row = `
                        <tr>
                            <td style="font-size:0.85rem; color:var(--text-muted);">${date}</td>
                            <td>${w.userName}</td>
                            <td style="color:var(--gold); font-weight:bold;">₹${w.amount}</td>
                            <td style="font-family:monospace; color:var(--accent);">${w.upi}</td>
                            <td><span class="badge ${badge}">${w.status}</span></td>
                            <td>
                                ${w.status === 'Pending' ? `
                                    <div class="action-group">
                                        <button class="btn-action btn-green" onclick="markPaid('${wid}')"><i class="fas fa-check"></i> Paid</button>
                                        <button class="btn-action btn-red" onclick="rejectWithdraw('${wid}')"><i class="fas fa-times"></i> Reject</button>
                                    </div>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        }

        window.markPaid = async (wid) => {
            if(!confirm("Mark as Paid?")) return;
            await updateDoc(doc(db, "withdrawals", wid), { status: "Paid" });
        }
        
        window.rejectWithdraw = async (wid) => {
            if(!confirm("Reject withdrawal?")) return;
            await updateDoc(doc(db, "withdrawals", wid), { status: "Rejected" });
        }

    </script>
</body>
</html>
