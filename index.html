<script>
    // FINAL FIXED CONFIG - No more typos
    const firebaseConfig = {
        apiKey: "AIzaSyAN_hd0rr46X2Sl0Z0cKwe0pAV12sh6iAI",
        authDomain: "famex-4cb1e.firebaseapp.com",
        projectId: "famex-4cb1e",
        storageBucket: "famex-4cb1e.firebasestorage.app",
        messagingSenderId: "395925089964",
        appId: "1:395925089964:web:551ef2009aa25d09743909",
        measurementId: "G-S1T0L618XL"
    };

    // Initialize
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function handleAuth(type) {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        
        if(!email || !pass) {
            alert("Please enter both Email and Password");
            return;
        }
        
        if (type === 'signup') {
            alert("Creating account... please wait.");
            auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                db.collection('users').doc(cred.user.uid).set({ balance: 0 });
                alert("Account created successfully!");
            }).catch(e => alert("Signup Error: " + e.message));
        } else {
            alert("Logging in...");
            auth.signInWithEmailAndPassword(email, pass).catch(e => alert("Login Failed: " + e.message));
        }
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            console.log("Logged in:", user.email);
            document.getElementById('auth-forms').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('balance-display').classList.remove('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            
            // Real-time balance update
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if(doc.exists) {
                    document.getElementById('user-balance').innerText = doc.data().balance;
                } else {
                    // Create doc if it doesn't exist for Google users
                    db.collection('users').doc(user.uid).set({ balance: 0 });
                }
            });
        }
    });

    function showPanel(type) {
        document.getElementById('order-panel').classList.toggle('hidden', type !== 'order');
        document.getElementById('funds-panel').classList.toggle('hidden', type !== 'funds');
    }

    async function submitOrder() {
        const user = auth.currentUser;
        const price = parseInt(document.getElementById('service-select').value);
        const qty = parseInt(document.getElementById('quantity').value);
        const link = document.getElementById('target-link').value;
        const cost = (price / 1000) * qty;

        if(!link) return alert("Please enter an Instagram Link");
        if(qty < 10) return alert("Minimum quantity is 10");

        const doc = await db.collection('users').doc(user.uid).get();
        const currentBal = doc.data().balance || 0;

        if (currentBal >= cost) {
            await db.collection('users').doc(user.uid).update({ balance: currentBal - cost });
            await db.collection('orders').add({
                uid: user.uid, email: user.email, link: link,
                quantity: qty, cost: cost, status: 'Pending', 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Order Placed Successfully!");
        } else { 
            alert("Insufficient Balance! You need â‚¹" + cost.toFixed(2)); 
        }
    }

    function submitDeposit() {
        const utr = document.getElementById('utr-id').value;
        if(!utr || utr.length < 8) return alert("Enter a valid Transaction ID / UTR");
        
        db.collection('deposits').add({
            uid: auth.currentUser.uid, 
            email: auth.currentUser.email,
            utr: utr, 
            status: 'Pending', 
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("Request sent! Admin will verify and add funds within 15-30 minutes.");
            document.getElementById('utr-id').value = "";
        });
    }

    document.getElementById('logout-btn').onclick = () => {
        auth.signOut().then(() => {
            alert("Logged out!");
            location.reload();
        });
    };
</script>
